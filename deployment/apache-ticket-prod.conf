# Ticket System - Apache Configuration (Production)
# Location: /etc/apache2/sites-available/ticket-prod.conf
# Enable with: sudo a2ensite ticket-prod.conf

<VirtualHost *:80>
    ServerName support.kleverchain.cloud

    # Redirect HTTP to HTTPS (uncomment after SSL is configured)
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Serve static frontend files
    DocumentRoot /var/www/ticket-system-prod/frontend/dist

    <Directory /var/www/ticket-system-prod/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # SPA routing - serve index.html for all non-file routes
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/api
        RewriteCond %{REQUEST_URI} !^/webhooks
        RewriteRule . /index.html [L]
    </Directory>

    ProxyPreserveHost On
    ProxyRequests Off

    # Backend API
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api

    # Webhooks
    ProxyPass /webhooks http://localhost:3001/webhooks
    ProxyPassReverse /webhooks http://localhost:3001/webhooks

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"

    # Cache static assets
    <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/ticket-prod-error.log
    CustomLog ${APACHE_LOG_DIR}/ticket-prod-access.log combined
</VirtualHost>

# HTTPS Configuration (enabled by Certbot)
# <VirtualHost *:443>
#     ServerName support.kleverchain.cloud
#
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/support.kleverchain.cloud/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/support.kleverchain.cloud/privkey.pem
#     Include /etc/letsencrypt/options-ssl-apache.conf
#
#     DocumentRoot /var/www/ticket-system-prod/frontend/dist
#
#     <Directory /var/www/ticket-system-prod/frontend/dist>
#         Options -Indexes +FollowSymLinks
#         AllowOverride All
#         Require all granted
#
#         RewriteEngine On
#         RewriteBase /
#         RewriteRule ^index\.html$ - [L]
#         RewriteCond %{REQUEST_FILENAME} !-f
#         RewriteCond %{REQUEST_FILENAME} !-d
#         RewriteCond %{REQUEST_URI} !^/api
#         RewriteCond %{REQUEST_URI} !^/webhooks
#         RewriteRule . /index.html [L]
#     </Directory>
#
#     ProxyPreserveHost On
#     ProxyRequests Off
#
#     ProxyPass /api http://localhost:3001/api
#     ProxyPassReverse /api http://localhost:3001/api
#
#     ProxyPass /webhooks http://localhost:3001/webhooks
#     ProxyPassReverse /webhooks http://localhost:3001/webhooks
#
#     Header always set X-Content-Type-Options "nosniff"
#     Header always set X-Frame-Options "SAMEORIGIN"
#     Header always set X-XSS-Protection "1; mode=block"
#
#     <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$">
#         Header set Cache-Control "public, max-age=31536000, immutable"
#     </LocationMatch>
#
#     ErrorLog ${APACHE_LOG_DIR}/ticket-prod-error.log
#     CustomLog ${APACHE_LOG_DIR}/ticket-prod-access.log combined
# </VirtualHost>
