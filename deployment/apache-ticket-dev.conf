# Ticket System - Apache Configuration (Development)
# Location: /etc/apache2/sites-available/ticket-dev.conf
# Enable with: sudo a2ensite ticket-dev.conf

<VirtualHost *:80>
    ServerName dev.kleverchain.cloud

    # Redirect HTTP to HTTPS (uncomment after SSL is configured)
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    ProxyPreserveHost On
    ProxyRequests Off

    # Backend API - MUST come before / to match first
    ProxyPass /api http://localhost:3101/api
    ProxyPassReverse /api http://localhost:3101/api

    # Webhooks - MUST come before /
    ProxyPass /webhooks http://localhost:3101/webhooks
    ProxyPassReverse /webhooks http://localhost:3101/webhooks

    # Frontend (Vite dev server) - catch-all LAST
    ProxyPass / http://localhost:5173/
    ProxyPassReverse / http://localhost:5173/

    # WebSocket support for Vite HMR
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) ws://localhost:5173/$1 [P,L]

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/ticket-dev-error.log
    CustomLog ${APACHE_LOG_DIR}/ticket-dev-access.log combined
</VirtualHost>

# HTTPS Configuration (enabled by Certbot)
# <VirtualHost *:443>
#     ServerName dev.kleverchain.cloud
#
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/dev.kleverchain.cloud/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/dev.kleverchain.cloud/privkey.pem
#     Include /etc/letsencrypt/options-ssl-apache.conf
#
#     ProxyPreserveHost On
#     ProxyRequests Off
#
#     # Frontend (Vite dev server)
#     ProxyPass / http://localhost:5173/
#     ProxyPassReverse / http://localhost:5173/
#
#     # WebSocket support for Vite HMR
#     RewriteEngine On
#     RewriteCond %{HTTP:Upgrade} websocket [NC]
#     RewriteCond %{HTTP:Connection} upgrade [NC]
#     RewriteRule ^/?(.*) ws://localhost:5173/$1 [P,L]
#
#     # Backend API
#     ProxyPass /api http://localhost:3101/api
#     ProxyPassReverse /api http://localhost:3101/api
#
#     # Webhooks
#     ProxyPass /webhooks http://localhost:3101/webhooks
#     ProxyPassReverse /webhooks http://localhost:3101/webhooks
#
#     ErrorLog ${APACHE_LOG_DIR}/ticket-dev-error.log
#     CustomLog ${APACHE_LOG_DIR}/ticket-dev-access.log combined
# </VirtualHost>
