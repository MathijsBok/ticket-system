generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  AGENT
  ADMIN
}

enum TicketStatus {
  NEW
  OPEN
  PENDING
  ON_HOLD
  SOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TicketChannel {
  EMAIL
  WEB
  API
  SLACK
  INTERNAL
}

enum CommentChannel {
  WEB
  EMAIL
  SLACK
  API
  SYSTEM
}

model User {
  id                String    @id @default(uuid()) @db.Uuid
  clerkId           String    @unique
  email             String    @unique
  firstName         String?
  lastName          String?
  role              UserRole  @default(USER)
  organizationId    String?   @db.Uuid
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organization      Organization?   @relation(fields: [organizationId], references: [id])
  ticketsCreated    Ticket[]        @relation("TicketRequester")
  ticketsAssigned   Ticket[]        @relation("TicketAssignee")
  comments          Comment[]
  attachments       Attachment[]
  agentSessions     AgentSession[]

  @@index([clerkId])
  @@index([email])
  @@index([role])
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  tickets   Ticket[]
}

model Ticket {
  id              String          @id @default(uuid()) @db.Uuid
  ticketNumber    Int             @unique @default(autoincrement())
  subject         String          @db.VarChar(500)
  status          TicketStatus    @default(NEW)
  priority        TicketPriority  @default(NORMAL)
  channel         TicketChannel
  requesterId     String          @db.Uuid
  assigneeId      String?         @db.Uuid
  organizationId  String?         @db.Uuid
  formId          String?         @db.Uuid
  categoryId      String?         @db.Uuid
  dueAt           DateTime?
  firstResponseAt DateTime?
  solvedAt        DateTime?
  closedAt        DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  requester       User            @relation("TicketRequester", fields: [requesterId], references: [id])
  assignee        User?           @relation("TicketAssignee", fields: [assigneeId], references: [id])
  organization    Organization?   @relation(fields: [organizationId], references: [id])
  form            Form?           @relation(fields: [formId], references: [id])
  category        Category?       @relation(fields: [categoryId], references: [id])
  comments        Comment[]
  attachments     Attachment[]
  activities      TicketActivity[]

  @@index([ticketNumber], name: "idx_tickets_number")
  @@index([status], name: "idx_tickets_status")
  @@index([requesterId], name: "idx_tickets_requester")
  @@index([assigneeId], name: "idx_tickets_assignee")
  @@index([createdAt], name: "idx_tickets_created")
  @@index([status, assigneeId], name: "idx_tickets_status_assignee")
}

model Comment {
  id          String         @id @default(uuid()) @db.Uuid
  ticketId    String         @db.Uuid
  authorId    String         @db.Uuid
  body        String         @db.Text
  bodyPlain   String         @db.Text
  isInternal  Boolean        @default(false)
  isSystem    Boolean        @default(false)
  channel     CommentChannel
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  ticket      Ticket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author      User           @relation(fields: [authorId], references: [id])
  attachments Attachment[]

  @@index([ticketId], name: "idx_comments_ticket")
  @@index([authorId], name: "idx_comments_author")
  @@index([createdAt], name: "idx_comments_created")
}

model Attachment {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @db.Uuid
  commentId   String?  @db.Uuid
  uploaderId  String   @db.Uuid
  filename    String   @db.VarChar(255)
  filePath    String   @db.VarChar(500)
  fileSize    BigInt
  mimeType    String   @db.VarChar(100)
  createdAt   DateTime @default(now())

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  comment     Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  uploader    User     @relation(fields: [uploaderId], references: [id])

  @@index([ticketId], name: "idx_attachments_ticket")
  @@index([commentId], name: "idx_attachments_comment")
}

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets     Ticket[]
}

model Form {
  id          String      @id @default(uuid()) @db.Uuid
  name        String
  description String?
  isActive    Boolean     @default(true)
  fields      Json        // JSON array of form field definitions
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  tickets     Ticket[]
}

model TicketActivity {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @db.Uuid
  userId      String?  @db.Uuid
  action      String   // e.g., "status_changed", "assigned", "comment_added"
  details     Json     // Additional activity details
  createdAt   DateTime @default(now())

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
}

model AgentSession {
  id          String    @id @default(uuid()) @db.Uuid
  agentId     String    @db.Uuid
  loginAt     DateTime  @default(now())
  logoutAt    DateTime?
  duration    Int?      // Duration in seconds
  replyCount  Int       @default(0)
  ipAddress   String?
  userAgent   String?

  agent       User      @relation(fields: [agentId], references: [id])

  @@index([agentId])
  @@index([loginAt])
}
