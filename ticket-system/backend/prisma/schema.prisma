generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  AGENT
  ADMIN
}

enum TicketStatus {
  NEW
  OPEN
  PENDING
  ON_HOLD
  SOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TicketChannel {
  EMAIL
  WEB
  API
  SLACK
  INTERNAL
}

enum CommentChannel {
  WEB
  EMAIL
  SLACK
  API
  SYSTEM
}

model User {
  id             String    @id @default(uuid()) @db.Uuid
  clerkId        String    @unique
  email          String    @unique
  firstName      String?
  lastName       String?
  role           UserRole  @default(USER)
  organizationId String?   @db.Uuid
  timezone       String?
  lastSeenAt     DateTime?
  isBlocked      Boolean   @default(false)
  blockedAt      DateTime?
  blockedReason  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization    Organization?     @relation(fields: [organizationId], references: [id])
  ticketsCreated  Ticket[]          @relation("TicketRequester")
  ticketsAssigned Ticket[]          @relation("TicketAssignee")
  comments        Comment[]
  attachments     Attachment[]
  agentSessions   AgentSession[]
  timeEntries     TicketTimeEntry[]
  activities      TicketActivity[]  @relation("UserActivities")
  mentions        Mention[]
  notifications   Notification[]
  bugsReported    Bug[]             @relation("BugReporter")
  bugsSolved      Bug[]             @relation("BugSolver")

  @@index([clerkId])
  @@index([email])
  @@index([role])
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users   User[]
  tickets Ticket[]
}

model Ticket {
  id              String         @id @default(uuid()) @db.Uuid
  ticketNumber    Int            @unique @default(autoincrement())
  subject         String         @db.VarChar(500)
  status          TicketStatus   @default(NEW)
  priority        TicketPriority @default(NORMAL)
  channel         TicketChannel
  requesterId     String         @db.Uuid
  assigneeId      String?        @db.Uuid
  organizationId  String?        @db.Uuid
  formId          String?        @db.Uuid
  categoryId      String?        @db.Uuid
  relatedTicketId String?        @db.Uuid
  country         String?        @db.VarChar(100)
  ipAddress       String?        @db.VarChar(50)
  dueAt           DateTime?
  firstResponseAt DateTime?
  solvedAt        DateTime?
  closedAt        DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  requester       User              @relation("TicketRequester", fields: [requesterId], references: [id])
  assignee        User?             @relation("TicketAssignee", fields: [assigneeId], references: [id])
  organization    Organization?     @relation(fields: [organizationId], references: [id])
  form            Form?             @relation(fields: [formId], references: [id])
  category        Category?         @relation(fields: [categoryId], references: [id])
  relatedTicket   Ticket?           @relation("RelatedTickets", fields: [relatedTicketId], references: [id])
  followUpTickets Ticket[]          @relation("RelatedTickets")
  comments        Comment[]
  attachments     Attachment[]
  activities      TicketActivity[]
  timeEntries     TicketTimeEntry[]
  formResponses   FormResponse[]

  @@index([ticketNumber], name: "idx_tickets_number")
  @@index([status], name: "idx_tickets_status")
  @@index([requesterId], name: "idx_tickets_requester")
  @@index([assigneeId], name: "idx_tickets_assignee")
  @@index([createdAt], name: "idx_tickets_created")
  @@index([status, assigneeId], name: "idx_tickets_status_assignee")
  @@index([relatedTicketId], name: "idx_tickets_related")
}

model Comment {
  id         String         @id @default(uuid()) @db.Uuid
  ticketId   String         @db.Uuid
  authorId   String         @db.Uuid
  body       String         @db.Text
  bodyPlain  String         @db.Text
  isInternal Boolean        @default(false)
  isSystem   Boolean        @default(false)
  channel    CommentChannel
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  ticket      Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author      User         @relation(fields: [authorId], references: [id])
  attachments Attachment[]
  mentions    Mention[]

  @@index([ticketId], name: "idx_comments_ticket")
  @@index([authorId], name: "idx_comments_author")
  @@index([createdAt], name: "idx_comments_created")
}

model Attachment {
  id         String   @id @default(uuid()) @db.Uuid
  ticketId   String   @db.Uuid
  commentId  String?  @db.Uuid
  uploaderId String   @db.Uuid
  filename   String   @db.VarChar(255)
  filePath   String   @db.VarChar(500)
  fileSize   BigInt
  mimeType   String   @db.VarChar(100)
  createdAt  DateTime @default(now())

  ticket   Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  comment  Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  uploader User     @relation(fields: [uploaderId], references: [id])

  @@index([ticketId], name: "idx_attachments_ticket")
  @@index([commentId], name: "idx_attachments_comment")
}

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets Ticket[]
}

model Form {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  fields      Json? // JSON array of form field definitions (kept for migration)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets    Ticket[]
  formFields FormField[]
}

model TicketActivity {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @db.Uuid
  userId    String?  @db.Uuid
  action    String // e.g., "status_changed", "assigned", "comment_added"
  details   Json // Additional activity details
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?  @relation("UserActivities", fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

model AgentSession {
  id         String    @id @default(uuid()) @db.Uuid
  agentId    String    @db.Uuid
  loginAt    DateTime  @default(now())
  logoutAt   DateTime?
  duration   Int? // Duration in seconds
  replyCount Int       @default(0)
  ipAddress  String?
  userAgent  String?

  agent User @relation(fields: [agentId], references: [id])

  @@index([agentId])
  @@index([loginAt])
}

model TicketTimeEntry {
  id          String    @id @default(uuid()) @db.Uuid
  ticketId    String    @db.Uuid
  agentId     String    @db.Uuid
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  duration    Int? // Duration in seconds
  description String? // Optional note about what was done
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  agent  User   @relation(fields: [agentId], references: [id])

  @@index([ticketId])
  @@index([agentId])
  @@index([startedAt])
}

model FormFieldLibrary {
  id             String   @id @default(uuid()) @db.Uuid
  label          String   @db.VarChar(255)
  fieldType      String   @db.VarChar(50)
  required       Boolean  @default(false)
  options        Json?
  placeholder    String?  @db.VarChar(255)
  defaultValue   String?  @db.Text
  zendeskFieldId BigInt?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  formFields    FormField[]
  formResponses FormResponse[]

  @@index([fieldType])
  @@index([zendeskFieldId])
}

model FormField {
  id       String  @id @default(uuid()) @db.Uuid
  formId   String  @db.Uuid
  fieldId  String  @db.Uuid
  order    Int
  required Boolean @default(false)

  form  Form             @relation(fields: [formId], references: [id], onDelete: Cascade)
  field FormFieldLibrary @relation(fields: [fieldId], references: [id])

  @@unique([formId, fieldId])
  @@index([formId])
  @@index([fieldId])
}

model FormResponse {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @db.Uuid
  fieldId   String   @db.Uuid
  value     String   @db.Text
  createdAt DateTime @default(now())

  ticket Ticket           @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  field  FormFieldLibrary @relation(fields: [fieldId], references: [id])

  @@index([ticketId])
  @@index([fieldId])
}

model Settings {
  id                          String   @id @default(uuid()) @db.Uuid
  // Email Settings
  sendTicketCreatedEmail      Boolean  @default(true)
  sendTicketAssignedEmail     Boolean  @default(true)
  sendTicketResolvedEmail     Boolean  @default(true)
  sendPendingTicketReminder   Boolean  @default(false)
  pendingTicketReminderHours  Int      @default(24) // Hours after agent reply to remind user

  // Auto-close Settings
  autoCloseEnabled            Boolean  @default(false)
  autoCloseHours              Int      @default(48) // Hours after solved to auto-close

  // Auto-solve Settings
  autoSolveEnabled            Boolean  @default(false)
  autoSolveHours              Int      @default(48) // Hours of no user reply to auto-solve

  // General Settings
  defaultTicketPriority       String   @default("NORMAL")
  allowCustomerReopenClosed   Boolean  @default(false)

  // Attachment Cleanup Settings
  autoDeleteAttachmentsEnabled Boolean @default(false)
  autoDeleteAttachmentsDays    Int     @default(90) // Days after upload to delete attachments

  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

// Email Template Types
enum EmailTemplateType {
  TICKET_CREATED
  NEW_REPLY
  TICKET_RESOLVED
  PENDING_REMINDER_24H
  PENDING_REMINDER_48H
}

// Email Templates for notifications
model EmailTemplate {
  id        String            @id @default(uuid()) @db.Uuid
  type      EmailTemplateType @unique
  name      String            @db.VarChar(255)
  subject   String            @db.VarChar(500)
  bodyHtml  String            @db.Text
  bodyPlain String            @db.Text
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([type])
}

// Macros - Pre-built reply templates for agents
model Macro {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  content   String   @db.Text
  category  String?  @db.VarChar(100)
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([order])
}

// Mention - tracks @mentions of agents in comments
model Mention {
  id              String   @id @default(uuid()) @db.Uuid
  commentId       String   @db.Uuid
  mentionedUserId String   @db.Uuid
  createdAt       DateTime @default(now())

  comment       Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentionedUser User    @relation(fields: [mentionedUserId], references: [id])

  @@unique([commentId, mentionedUserId])
  @@index([commentId])
  @@index([mentionedUserId])
}

// Bug status
enum BugStatus {
  OPEN
  SOLVED
}

// Notification types
enum NotificationType {
  MENTION
  TICKET_ASSIGNED
  TICKET_UPDATED
  NEW_REPLY
  BUG_REPORTED
}

// Notification - alerts for users
model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @db.Uuid
  type      NotificationType
  title     String           @db.VarChar(255)
  message   String           @db.Text
  ticketId  String?          @db.Uuid
  commentId String?          @db.Uuid
  bugId     String?          @db.Uuid
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
}

// Bug reports from agents/admins
model Bug {
  id          String    @id @default(uuid()) @db.Uuid
  title       String    @db.VarChar(255)
  description String    @db.Text
  status      BugStatus @default(OPEN)
  reportedById String   @db.Uuid
  solvedById  String?   @db.Uuid
  createdAt   DateTime  @default(now())
  solvedAt    DateTime?
  updatedAt   DateTime  @updatedAt

  reportedBy User  @relation("BugReporter", fields: [reportedById], references: [id])
  solvedBy   User? @relation("BugSolver", fields: [solvedById], references: [id])

  @@index([status])
  @@index([reportedById])
  @@index([createdAt])
}
